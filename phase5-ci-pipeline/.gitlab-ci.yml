stages:
  - build
  - gitops

default:
  tags:
    - docker

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DOCKER_TLS_CERTDIR: ""
  GITOPS_BRANCH: "main"
  GITOPS_FILE: "apps/boutique/overlays/dev/kustomization.yaml"
  CI_GROUP: "root"
  CI_APP_PROJECT: "app-repo"
  UPSTREAM_REGISTRY: "us-central1-docker.pkg.dev/google-samples/microservices-demo"
  BOUTIQUE_SERVICES: >-
    adservice
    cartservice
    checkoutservice
    currencyservice
    emailservice
    frontend
    paymentservice
    productcatalogservice
    recommendationservice
    shippingservice

# ==============================================================================
# Stage 1: build
# ==============================================================================
build_boutique_images:
  stage: build
  image: docker:27-cli

  before_script:
    - |
      if [ -z "${GITLAB_CA_CERT_B64:-}" ]; then
        echo "GITLAB_CA_CERT_B64 CI Variable 없음. 32-setup-gitlab-ci.sh 실행 필요"
        exit 1
      fi
      mkdir -p "/etc/docker/certs.d/${REGISTRY_HOSTPORT}"
      echo "$GITLAB_CA_CERT_B64" | base64 -d \
        > "/etc/docker/certs.d/${REGISTRY_HOSTPORT}/ca.crt"
      echo "Docker CA 등록 완료"
    - |
      echo "${CI_REGISTRY_PASSWORD}" | \
        docker login "${REGISTRY_HOSTPORT}" \
          -u "${CI_REGISTRY_USER}" --password-stdin
      echo "Registry 로그인 완료"

  script:
    - export IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
    - export OUR_REGISTRY="${REGISTRY_HOSTPORT}/${CI_GROUP}/${CI_APP_PROJECT}"
    - |
      set -eu
      echo "Build 시작 IMAGE_TAG=${IMAGE_TAG} Registry=${OUR_REGISTRY}"

      FAILED_SERVICES=""

      for svc in $BOUTIQUE_SERVICES; do
        SVC_ROOT="./src/${svc}"

        if [ ! -d "$SVC_ROOT" ]; then
          echo "서비스 디렉터리 없음: $SVC_ROOT"
          exit 1
        fi

        DOCKERFILE_PATH="$(find "$SVC_ROOT" -type f -name Dockerfile | head -n1)"
        if [ -z "$DOCKERFILE_PATH" ]; then
          echo "Dockerfile 없음: $SVC_ROOT"
          exit 1
        fi

        BUILD_CTX="$(dirname "$DOCKERFILE_PATH")"
        FULL_IMAGE="${OUR_REGISTRY}/${svc}:${IMAGE_TAG}"

        echo "==> [${svc}] 빌드 시작: ${FULL_IMAGE}"

        if ! docker build --progress=plain --pull \
            -f "$DOCKERFILE_PATH" \
            -t "$FULL_IMAGE" \
            "$BUILD_CTX"; then
          echo "[${svc}] 빌드 실패"
          FAILED_SERVICES="${FAILED_SERVICES} ${svc}"
          continue
        fi

        if ! docker push "$FULL_IMAGE"; then
          echo "[${svc}] push 실패"
          FAILED_SERVICES="${FAILED_SERVICES} ${svc}"
          docker image rm "$FULL_IMAGE" || true
          continue
        fi

        docker image rm "$FULL_IMAGE" || true
        echo "[${svc}] 완료"
      done

      docker builder prune -f --filter "until=24h" || true
      docker system df || true

      if [ -n "$FAILED_SERVICES" ]; then
        echo "빌드/push 실패 서비스: ${FAILED_SERVICES}"
        exit 1
      fi

      echo "전체 빌드/push 완료 IMAGE_TAG=${IMAGE_TAG}"

    - printf "IMAGE_TAG=%s\n" "${CI_COMMIT_SHORT_SHA}" > build.env

  artifacts:
    reports:
      dotenv: build.env
    expire_in: 1 hour

  rules:
    - if: '$CI_COMMIT_BRANCH'

# ==============================================================================
# Stage 2: gitops
# ==============================================================================
update_gitops_tags:
  stage: gitops
  image: alpine:3.20
  needs: ["build_boutique_images"]
  resource_group: boutique-gitops-update

  before_script:
    - apk add --no-cache git curl ca-certificates
    - |
      curl -fsSL \
        https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 \
        -o /usr/local/bin/yq
      chmod +x /usr/local/bin/yq
    - |
      if [ -z "${GITLAB_CA_CERT_B64:-}" ]; then
        echo "GITLAB_CA_CERT_B64 CI Variable 없음"
        exit 1
      fi
      echo "$GITLAB_CA_CERT_B64" | base64 -d \
        > /usr/local/share/ca-certificates/gitlab-ca.crt
      update-ca-certificates --fresh 2>/dev/null || true
      git config --global http.sslCAInfo \
        /usr/local/share/ca-certificates/gitlab-ca.crt
      echo "git SSL CA 등록 완료"

  script:
    - |
      set -eu

      : "${GITOPS_PUSH_USER:?}"
      : "${GITOPS_PUSH_TOKEN:?}"
      : "${GITOPS_REPO_URL:?}"
      : "${IMAGE_TAG:?}"
      : "${REGISTRY_HOSTPORT:?}"

      OUR_REGISTRY="${REGISTRY_HOSTPORT}/${CI_GROUP}/${CI_APP_PROJECT}"

      echo "GitOps 태그 업데이트 IMAGE_TAG=${IMAGE_TAG}"

      set +x
      AUTH_URL="$(echo "$GITOPS_REPO_URL" | \
        sed "s|https://|https://${GITOPS_PUSH_USER}:${GITOPS_PUSH_TOKEN}@|")"
      set -x

      git clone "$AUTH_URL" /tmp/gitops
      cd /tmp/gitops

      git config user.name "gitlab-ci-bot"
      git config user.email "gitlab-ci@local"

      if [ ! -f "$GITOPS_FILE" ]; then
        echo "GitOps 파일 없음: $GITOPS_FILE"
        echo "31-setup-gitops-repo.sh 를 먼저 실행하세요"
        exit 1
      fi

      for svc in $BOUTIQUE_SERVICES; do
        MATCH_NAME="${UPSTREAM_REGISTRY}/${svc}"
        NEW_NAME="${OUR_REGISTRY}/${svc}"
        NEW_TAG="${IMAGE_TAG}"

        MATCH_NAME="$MATCH_NAME" NEW_NAME="$NEW_NAME" NEW_TAG="$NEW_TAG" \
        yq -i '
          (.images[] | select(.name == strenv(MATCH_NAME))).newName = strenv(NEW_NAME) |
          (.images[] | select(.name == strenv(MATCH_NAME))).newTag  = strenv(NEW_TAG)
        ' "$GITOPS_FILE"

        echo "  ${svc} -> ${NEW_NAME}:${NEW_TAG}"
      done

      git add "$GITOPS_FILE"

      if git diff --cached --quiet; then
        echo "변경 없음 push 스킵"
        exit 0
      fi

      git commit -m "ci: bump images to ${IMAGE_TAG} [skip ci]"

      PUSH_RETRY=0
      until git push origin "HEAD:${GITOPS_BRANCH}"; do
        PUSH_RETRY=$((PUSH_RETRY + 1))
        if [ $PUSH_RETRY -ge 3 ]; then
          echo "gitops push 최종 실패"
          exit 1
        fi
        echo "push 충돌 rebase 재시도 ${PUSH_RETRY}/3"
        git pull --rebase origin "${GITOPS_BRANCH}"
      done

      echo "gitops-repo 태그 업데이트 완료"

  rules:
    - if: '$CI_COMMIT_BRANCH'
